#!/bin/bash
# Update the version number
set -Eeuo pipefail
trap 'echo "${BASH_SOURCE[0]}: line $LINENO: $BASH_COMMAND: exitcode $?"' ERR
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

PROJECT_PATH="./sv"

# Function to display usage
show_usage() {
    cat << EOF
Usage: bump-version [TYPE]

Bump the version number, commit changes on a branch, and push for a PR.

Arguments:
  TYPE        Version bump type: major, minor, or patch (default: patch)
              
              major: X.0.0 (increment major version, reset minor and patch)
              minor: X.Y.0 (increment minor version, reset patch)
              patch: X.Y.Z (increment patch version)

Options:
  -h, --help  Show this help message and exit

Examples:
  bump-version        # Bumps patch version (e.g., 1.2.3 -> 1.2.4)
  bump-version minor  # Bumps minor version (e.g., 1.2.3 -> 1.3.0)
  bump-version major  # Bumps major version (e.g., 1.2.3 -> 2.0.0)

Note: Requires a clean git workspace (no uncommitted changes or untracked files).
      This script does not create or push tags; tagging should happen after merge.
EOF
}

# Check for help flag
if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
    show_usage
    exit 0
fi

# Check the project file exists
if [[ ! -f "$PROJECT_PATH" ]]; then
  echo "ERROR: Cannot find $PROJECT_PATH"
  exit 1
fi

# Check for clean git workspace
if ! git diff-index --quiet HEAD -- || [[ -n "$(git ls-files --others --exclude-standard)" ]]; then
    echo "Error: Git workspace has uncommitted changes or untracked files."
    echo "Please commit or stash your changes before bumping the version."
    git status --short
    exit 1
fi

# Get current version
CURRENT_VERSION=$(awk -F'"' '/^readonly VERSION="[0-9.]*"/ {print $2; exit}' "$PROJECT_PATH")
echo "Current version: $CURRENT_VERSION"

# Parse version components
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

# Default to patch bump
BUMP_TYPE="${1:-patch}"

case "$BUMP_TYPE" in
  major)
    MAJOR=$((MAJOR + 1))
    MINOR=0
    PATCH=0
    ;;
  minor)
    MINOR=$((MINOR + 1))
    PATCH=0
    ;;
  patch)
    PATCH=$((PATCH + 1))
    ;;
  *)
    echo "Invalid bump type. Use: major, minor, or patch"
    exit 1
    ;;
esac

NEW_VERSION="$MAJOR.$MINOR.$PATCH"
echo "New version: $NEW_VERSION"

# Update version
sed -i '' "s/^readonly VERSION=\"$CURRENT_VERSION\"/readonly VERSION=\"$NEW_VERSION\"/" "$PROJECT_PATH"

# Create a bump branch if currently on a protected default branch
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
case "$CURRENT_BRANCH" in
  main|master)
    BUMP_BRANCH="bump-version-v$NEW_VERSION"
    if git show-ref --verify --quiet "refs/heads/$BUMP_BRANCH"; then
      echo "Error: Branch $BUMP_BRANCH already exists."
      echo "Please delete it or choose a different version."
      exit 1
    fi
    git checkout -b "$BUMP_BRANCH"
    ;;
  *)
    BUMP_BRANCH="$CURRENT_BRANCH"
    ;;
esac

# Stage the changes
git add -A

# Commit with version message
git commit -m "Bump version to $NEW_VERSION"
git push -u origin "$BUMP_BRANCH"

echo "âœ“ Version bumped to $NEW_VERSION on branch $BUMP_BRANCH"
echo "Next: open a PR from $BUMP_BRANCH into your default branch."
