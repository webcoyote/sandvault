#!/bin/bash
# Use "system bash" (v3.2) to ensure compatibility with older versions
# Run per-suite test scripts
set -Eeuo pipefail
trap 'echo "${BASH_SOURCE[0]}: line $LINENO: $BASH_COMMAND: exitcode $?"' ERR
START_TIME=$(date +%s.%N)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

[[ "${VERBOSE:-0}" =~ ^[0-9]+$ ]] && VERBOSE="${VERBOSE:-0}" || VERBOSE=1

# We want to run the tests inside sandvault. However, sandvault
# may not have access to $SCRIPT_DIR, so we may need to copy to a
# temporary location that is accessible to sandvault-$USER
if [[ -z "${SV_SESSION_ID:-}" && -z "${SV_TESTS_REEXEC:-}" ]]; then
    # Hard-code sandvault shared directory location :(
    readonly SHARED_WORKSPACE="/Users/Shared/sv-$USER"
    case "$SCRIPT_DIR/" in
        "$SHARED_WORKSPACE"/*) ;;
        *)
            # Do not recurse
            export SV_TESTS_REEXEC=1

            if [[ "$VERBOSE" -ne 0 ]]; then
                echo "Cloning files to temporary folder in shared workspace"
            fi
            SRC_DIR="$(git rev-parse --show-toplevel)"
            readonly SRC_DIR
            DST_DIR="$(mktemp -d -p "$SHARED_WORKSPACE")"
            readonly DST_DIR
            trap 'rm -rf "$DST_DIR"' EXIT
            # git clone --depth 1 --no-local "$SRC_DIR" "$DST_DIR" &>/dev/null
            tar -c \
                -C "$SRC_DIR" \
                --exclude=".git" \
                --exclude="*/.build/*" \
                . | tar -xC "$DST_DIR"

            # GitHub actions uses Bash3.2 which does not support for "realpath --relative-to"
            # SCRIPT_RELATIVE_PATH="$(realpath --relative-to="$SRC_DIR" "${BASH_SOURCE[0]}")"
            BASE="$(cd "$SRC_DIR" && pwd -P)"
            TARGET="$(cd "$SCRIPT_DIR" && pwd -P)/$(basename "${BASH_SOURCE[0]}")"
            SCRIPT_RELATIVE_PATH="${TARGET#"$BASE/"}" # "tests/validate"
            if "$DST_DIR/$SCRIPT_RELATIVE_PATH" ; then
                exit 0
            else
                exit $?
            fi
            ;;
    esac
fi

TOTAL=0
PASSED=0
FAILED=0
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

shopt -s nullglob
for dir in *; do
    [[ -d "$dir" ]] || continue
    validate="$dir/scripts/validate"
    if [[ ! -x "$validate" ]]; then
        echo -e "  ${RED}FAIL${NC}: $(basename "$dir") (missing executable scripts/validate)"
        ((TOTAL++)) || true
        ((FAILED++)) || true
        continue
    fi

    ((TOTAL++)) || true
    if [[ "$VERBOSE" -ne 0 ]]; then
        echo "=== $validate ==="
    fi
    set +e
    # Run the tests in a sandbox
    "../sv" shell -- "$validate"
    status=$?
    set -e
    if [[ "$status" -eq 0 ]]; then
        ((PASSED++)) || true
        if [[ "$VERBOSE" -ne 0 ]]; then
            echo -e "  ${GREEN}PASS${NC}: $(basename "$dir")"
        fi
    else
        ((FAILED++)) || true
        echo -e "  ${RED}FAIL${NC}: $(basename "$dir") (exit $status)"
    fi
    if [[ "$VERBOSE" -ne 0 ]]; then
        echo
    fi

done
shopt -u nullglob

if [[ "$VERBOSE" -ne 0 ]]; then
    echo -e "Passed: ${GREEN}$PASSED${NC}"
    echo -e "Failed: ${RED}$FAILED${NC}"
    echo "Tests run: $TOTAL"
fi

if [[ "$FAILED" -gt 0 ]]; then
    exit 1
fi

END_TIME=$(date +%s.%N)
ELAPSED_TIME=$(echo "$END_TIME - $START_TIME" | bc --mathlib | xargs printf "%.2f\n")
if [[ "$VERBOSE" -ne 0 ]]; then
    echo -e "âœ… Tests completed in $ELAPSED_TIME seconds!"
fi
