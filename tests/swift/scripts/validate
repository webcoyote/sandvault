#!/bin/bash
# Test the project
set -Eeuo pipefail
trap 'echo "${BASH_SOURCE[0]}: line $LINENO: $BASH_COMMAND: exitcode $?"' ERR
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

ARGS=()

# Disable sandboxing when running inside sandvault to avoid nested sandbox-exec
if [[ -n "${SV_SESSION_ID:-}" ]]; then
    echo "swift project testing in sandvault sandbox"
    ARGS+=(--disable-sandbox)
fi

# Bash 3.2-safe: expand array only when set, with no empty arg
output=$(swift run --quiet ${ARGS[@]+"${ARGS[@]}"} "$@" | tail -n 1)
if [[ "$output" == "Hello world" ]]; then
    echo "PASS: output matched"
else
    echo "FAIL: expected 'Hello world', got '$output'"
    exit 1
fi
